@extends('layouts.master')

@section('title')
    Retention Management
@endsection

@section('css')
@endsection

@section('content')
    @component('components.breadcrumb')
        @slot('li_1')
            Retention
        @endslot
        @slot('title')
            Management
        @endslot
    @endcomponent

    @if (session('success'))
        <div class="alert alert-success alert-dismissible fade show alert-soft-success" role="alert">
            <i class="mdi mdi-check-all me-2"></i>
            <strong>Success!</strong> {{ session('success') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    @endif

    <div class="row mb-3">
        <div class="col-12">
            <h2 class="text-gold fw-bold">
                <i class="mdi mdi-shield-check-outline me-2"></i>Retention Management
            </h2>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-danger-subtle text-danger me-3">
                        <i class="bx bx-error fs-2"></i>
                    </div>
                    <div>
                        <p class="text-small-muted mb-1">Total Chargebacks</p>
                        <h3 class="mb-0 text-danger fw-bold">{{ $cb_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-warning-subtle text-warning me-3">
                        <i class="bx bx-refresh fs-2"></i>
                    </div>
                    <div>
                        <p class="text-small-muted mb-1">REWRITE</p>
                        <h3 class="mb-0 text-warning fw-bold">{{ $rewrite_count }}</h3>
                        <small class="text-muted">≥30 days old</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-info-subtle text-info me-3">
                        <i class="bx bx-time-five fs-2"></i>
                    </div>
                    <div>
                        <p class="text-small-muted mb-1">Yet to Retain</p>
                        <h3 class="mb-0 text-info fw-bold">{{ $yet_to_retain_count }}</h3>
                        <small class="text-muted">Pending action</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card shadow-sm">
                <div class="d-flex align-items-center">
                    <div class="stat-icon bg-success-subtle text-success me-3">
                        <i class="bx bx-check-circle fs-2"></i>
                    </div>
                    <div>
                        <p class="text-small-muted mb-1">Retained</p>
                        <h3 class="mb-0 text-success fw-bold">{{ $retained_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Retention Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom">
                    <h5 class="card-title mb-0 text-gold fw-semibold">
                        <i class="mdi mdi-table me-2"></i>Retention Management
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Search and Filter Form -->
                    <form method="GET" action="{{ route('retention.index') }}" class="mb-3">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" name="search" class="form-control form-control-sm" 
                                       placeholder="Search by name, phone, carrier, closer..." 
                                       value="{{ $search }}">
                            </div>
                            <div class="col-md-2">
                                <select name="month" class="form-select form-select-sm">
                                    <option value="">All Months</option>
                                    @for($m = 1; $m <= 12; $m++)
                                        <option value="{{ $m }}" {{ $month == $m ? 'selected' : '' }}>
                                            {{ \Carbon\Carbon::create()->month($m)->format('F') }}
                                        </option>
                                    @endfor
                                </select>
                            </div>
                            <div class="col-md-1">
                                <select name="year" class="form-select form-select-sm">
                                    <option value="">Year</option>
                                    @for($y = now()->year; $y >= now()->year - 5; $y--)
                                        <option value="{{ $y }}" {{ $year == $y ? 'selected' : '' }}>{{ $y }}</option>
                                    @endfor
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                    <i class="bx bx-search-alt me-1"></i>Filter
                                </button>
                            </div>
                            <div class="col-md-2">
                                <a href="{{ route('retention.index') }}" class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="bx bx-reset me-1"></i>Reset
                                </a>
                            </div>
                        </div>
                    </form>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs nav-tabs-custom nav-justified mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#yet-to-retain" role="tab">
                                <i class="bx bx-time-five me-1"></i>
                                <span class="d-none d-sm-inline">Yet to Retain</span>
                                <span class="badge bg-info ms-1">{{ $yet_to_retain_count }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#retained" role="tab">
                                <i class="bx bx-check-circle me-1"></i>
                                <span class="d-none d-sm-inline">Retained</span>
                                <span class="badge bg-success ms-1">{{ $retained_count }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#rewrite" role="tab">
                                <i class="bx bx-refresh me-1"></i>
                                <span class="d-none d-sm-inline">Rewrite</span>
                                <span class="badge bg-warning ms-1">{{ $rewrite_count }}</span>
                            </a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- YET TO RETAIN TAB -->
                        <div class="tab-pane active" id="yet-to-retain" role="tabpanel">
                            <div class="table-wrapper">
                                <table class="table table-striped table-bordered table-hover table-sm align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center" style="min-width:100px;">Call</th>
                                            <th style="min-width:70px;">ID</th>
                                            <th style="min-width:100px;">Sale Date</th>
                                            <th style="min-width:150px;">Customer Name</th>
                                            <th style="min-width:130px;">Phone</th>
                                            <th style="min-width:120px;">Closer</th>
                                            <th style="min-width:120px;">Carrier</th>
                                            <th style="min-width:120px;">Coverage</th>
                                            <th style="min-width:120px;">Premium</th>
                                            <th style="min-width:140px;">Retention Status</th>
                                            <th style="min-width:140px;">Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @forelse($yet_to_retain_leads as $lead)
                                            @php
                                                $chargebackDate = $lead->chargeback_marked_date ? \Carbon\Carbon::parse($lead->chargeback_marked_date) : null;
                                                $daysAgo = $chargebackDate ? $chargebackDate->diffInDays(now()) : 0;
                                            @endphp
                                            <tr data-lead-id="{{ $lead->id }}" data-customer-name="{{ $lead->cn_name }}" data-phone="{{ $lead->phone_number }}" data-days-ago="{{ $daysAgo }}">
                                                <td class="text-center">
                                                    <button class="btn btn-success btn-sm dial-lead-btn" 
                                                            onclick="dialLead({{ $lead->id }}, '{{ $lead->phone_number }}', '{{ $lead->cn_name }}', {{ $daysAgo }}, this)" 
                                                            title="Call Customer">
                                                        <i class="bx bx-phone-call"></i> Call
                                                    </button>
                                                </td>
                                                <td><strong>{{ $lead->id }}</strong></td>
                                                <td>{{ $lead->sale_date ? $lead->sale_date->format('M d, Y') : 'N/A' }}</td>
                                                <td><strong>{{ $lead->cn_name }}</strong></td>
                                                <td>{{ $lead->phone_number }}</td>
                                                <td>{{ $lead->closer_name ?? 'N/A' }}</td>
                                                <td>{{ $lead->carrier_name ?? 'N/A' }}</td>
                                                <td class="text-gold fw-semibold">${{ number_format($lead->coverage_amount ?? 0, 2) }}</td>
                                                <td class="text-gold fw-semibold">${{ number_format($lead->monthly_premium ?? 0, 2) }}</td>
                                                <td>
                                                    <select class="form-select form-select-sm retention-status-dropdown" 
                                                            data-lead-id="{{ $lead->id }}" 
                                                            style="min-width: 140px;">
                                                        <option value="pending" {{ ($lead->retention_status == 'pending' || !$lead->retention_status) ? 'selected' : '' }}>
                                                            Yet to Retain
                                                        </option>
                                                        <option value="retained" {{ $lead->retention_status == 'retained' ? 'selected' : '' }}>
                                                            Retained
                                                        </option>
                                                        <option value="rewrite" {{ $lead->retention_status == 'rewrite' ? 'selected' : '' }}>
                                                            Rewrite
                                                        </option>
                                                    </select>
                                                </td>
                                                <td>
                                                    @if($lead->is_rewrite)
                                                        <span class="badge bg-warning">
                                                            <i class="bx bx-refresh me-1"></i>REWRITE
                                                        </span>
                                                    @else
                                                        <span class="badge bg-info">
                                                            <i class="bx bx-redo me-1"></i>RECOVER
                                                        </span>
                                                    @endif
                                                </td>
                                            </tr>
                                        @empty
                                            <tr>
                                                <td colspan="11" class="text-center py-5 text-muted">
                                                    <i class="bx bx-inbox fs-1 mb-3 d-block"></i>
                                                    <p class="mb-0">No leads requiring retention</p>
                                                </td>
                                            </tr>
                                        @endforelse
                                    </tbody>
                                </table>
                            </div>
                            @if($yet_to_retain_leads->hasPages())
                                <div class="d-flex justify-content-center mt-4">
                                    {{ $yet_to_retain_leads->appends(['search' => $search, 'month' => $month, 'year' => $year])->links() }}
                                </div>
                            @endif
                        </div>

                        <!-- RETAINED TAB -->
                        <div class="tab-pane" id="retained" role="tabpanel">
                            <div class="table-wrapper">
                                <table class="table table-striped table-bordered table-hover table-sm align-middle">
                                    <thead class="table-success">
                                        <tr>
                                            <th style="min-width:70px;">ID</th>
                                            <th style="min-width:100px;">Sale Date</th>
                                            <th style="min-width:120px;">Retained Date</th>
                                            <th style="min-width:150px;">Customer Name</th>
                                            <th style="min-width:130px;">Phone</th>
                                            <th style="min-width:120px;">Closer</th>
                                            <th style="min-width:120px;">Carrier</th>
                                            <th style="min-width:120px;">Coverage</th>
                                            <th style="min-width:120px;">Premium</th>
                                            <th style="min-width:100px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @forelse($retained_leads as $lead)
                                            <tr>
                                                <td><strong>{{ $lead->id }}</strong></td>
                                                <td>{{ $lead->sale_date ? $lead->sale_date->format('M d, Y') : 'N/A' }}</td>
                                                <td>
                                                    <span class="badge bg-success">
                                                        <i class="bx bx-calendar-check me-1"></i>
                                                        {{ $lead->retained_at ? $lead->retained_at->format('M d, Y') : 'N/A' }}
                                                    </span>
                                                </td>
                                                <td><strong>{{ $lead->cn_name }}</strong></td>
                                                <td>{{ $lead->phone_number }}</td>
                                                <td>{{ $lead->closer_name ?? 'N/A' }}</td>
                                                <td>{{ $lead->carrier_name ?? 'N/A' }}</td>
                                                <td class="text-gold fw-semibold">${{ number_format($lead->coverage_amount ?? 0, 2) }}</td>
                                                <td class="text-gold fw-semibold">${{ number_format($lead->monthly_premium ?? 0, 2) }}</td>
                                                <td>
                                                    <span class="badge bg-success">
                                                        <i class="bx bx-check-circle me-1"></i>RETAINED
                                                    </span>
                                                </td>
                                            </tr>
                                        @empty
                                            <tr>
                                                <td colspan="10" class="text-center py-5 text-muted">
                                                    <i class="bx bx-inbox fs-1 mb-3 d-block"></i>
                                                    <p class="mb-0">No retained sales yet</p>
                                                </td>
                                            </tr>
                                        @endforelse
                                    </tbody>
                                </table>
                            </div>
                            @if($retained_leads->hasPages())
                                <div class="d-flex justify-content-center mt-4">
                                    {{ $retained_leads->appends(['search' => $search, 'month' => $month, 'year' => $year])->links() }}
                                </div>
                            @endif
                        </div>

                        <!-- REWRITE TAB -->
                        <div class="tab-pane" id="rewrite" role="tabpanel">
                            <div class="table-wrapper">
                                <table class="table table-striped table-bordered table-hover table-sm align-middle">
                                    <thead class="table-warning">
                                        <tr>
                                            <th style="min-width:70px;">ID</th>
                                            <th style="min-width:100px;">Sale Date</th>
                                            <th style="min-width:120px;">CB Date</th>
                                            <th style="min-width:80px;">Days Old</th>
                                            <th style="min-width:150px;">Customer Name</th>
                                            <th style="min-width:130px;">Phone</th>
                                            <th style="min-width:120px;">Closer</th>
                                            <th style="min-width:120px;">Carrier</th>
                                            <th style="min-width:120px;">Coverage</th>
                                            <th style="min-width:120px;">Premium</th>
                                            <th style="min-width:140px;">Retention Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @forelse($rewrite_leads as $lead)
                                            <tr>
                                                <td><strong>{{ $lead->id }}</strong></td>
                                                <td>{{ $lead->sale_date ? $lead->sale_date->format('M d, Y') : 'N/A' }}</td>
                                                <td>{{ $lead->chargeback_marked_date ? $lead->chargeback_marked_date->format('M d, Y') : 'N/A' }}</td>
                                                <td>
                                                    @if($lead->chargeback_marked_date && $lead->sale_date)
                                                        <span class="badge bg-warning-subtle text-warning">
                                                            {{ $lead->chargeback_marked_date->diffInDays($lead->sale_date) }} days
                                                        </span>
                                                    @else
                                                        -
                                                    @endif
                                                </td>
                                                <td><strong>{{ $lead->cn_name }}</strong></td>
                                                <td>{{ $lead->phone_number }}</td>
                                                <td>{{ $lead->closer_name ?? 'N/A' }}</td>
                                                <td>{{ $lead->carrier_name ?? 'N/A' }}</td>
                                                <td class="text-gold fw-semibold">${{ number_format($lead->coverage_amount ?? 0, 2) }}</td>
                                                <td class="text-gold fw-semibold">${{ number_format($lead->monthly_premium ?? 0, 2) }}</td>
                                                <td>
                                                    <select class="form-select form-select-sm retention-status-dropdown" 
                                                            data-lead-id="{{ $lead->id }}" 
                                                            style="min-width: 120px;">
                                                        <option value="pending" {{ ($lead->retention_status == 'pending' || !$lead->retention_status) ? 'selected' : '' }}>
                                                            Pending
                                                        </option>
                                                        <option value="retained" {{ $lead->retention_status == 'retained' ? 'selected' : '' }}>
                                                            Retained
                                                        </option>
                                                        <option value="lost" {{ $lead->retention_status == 'lost' ? 'selected' : '' }}>
                                                            Lost
                                                        </option>
                                                    </select>
                                                </td>
                                            </tr>
                                        @empty
                                            <tr>
                                                <td colspan="11" class="text-center py-5 text-muted">
                                                    <i class="bx bx-inbox fs-1 mb-3 d-block"></i>
                                                    <p class="mb-0">No rewrite cases (chargebacks ≥30 days old)</p>
                                                </td>
                                            </tr>
                                        @endforelse
                                    </tbody>
                                </table>
                            </div>
                            @if($rewrite_leads->hasPages())
                                <div class="d-flex justify-content-center mt-4">
                                    {{ $rewrite_leads->appends(['search' => $search, 'month' => $month, 'year' => $year])->links() }}
                                </div>
                            @endif
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection

@section('script')
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle retention status dropdown change
    const statusDropdowns = document.querySelectorAll('.retention-status-dropdown');
    
    statusDropdowns.forEach(dropdown => {
        dropdown.addEventListener('change', function() {
            const leadId = this.getAttribute('data-lead-id');
            const newStatus = this.value;
            const originalValue = this.querySelector('option[selected]')?.value || 'pending';
            
            // Show loading state
            this.disabled = true;
            
            // Send AJAX request to update status
            fetch(`/retention/${leadId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    this.classList.add('border-success');
                    setTimeout(() => {
                        this.classList.remove('border-success');
                    }, 2000);
                    
                    // Update the selected attribute
                    this.querySelectorAll('option').forEach(opt => opt.removeAttribute('selected'));
                    this.querySelector(`option[value="${newStatus}"]`).setAttribute('selected', 'selected');
                    
                    // If marked as retained, reload after 1 second to move to retained tab
                    if (newStatus === 'retained') {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    // Revert to original value on error
                    this.value = originalValue;
                    alert('Failed to update status. Please try again.');
                }
                this.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                this.value = originalValue;
                this.disabled = false;
                alert('An error occurred. Please try again.');
            });
        });
    });

    // Preserve active tab on page reload
    const activeTab = localStorage.getItem('activeRetentionTab');
    if (activeTab) {
        const tabTrigger = document.querySelector(`[href="${activeTab}"]`);
        if (tabTrigger) {
            const tab = new bootstrap.Tab(tabTrigger);
            tab.show();
        }
    }

    // Save active tab to localStorage
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (e) {
            localStorage.setItem('activeRetentionTab', e.target.getAttribute('href'));
        });
    });
});

// ===== AUTOMATIC CALL DETECTION & MODAL POPUP (Like Ravens) =====
let callModalInstance = null;
let currentLeadId = null;
let isCallActive = false;
let currentEventId = null;
let pollInterval = null;

// Get user's zoom number
window.zoomNumber = '{{ Auth::user()->zoom_number ?? '' }}';
window.sanitizedZoomNumber = '{{ Auth::user()->sanitized_zoom_number ?? '' }}';

// Start polling for call events when page loads
$(document).ready(function() {
    if (window.zoomNumber) {
        startCallPolling();
    }
});

// Call event polling system
function startCallPolling() {
    console.log('Starting call event polling for retention calls...');
    pollInterval = setInterval(checkForCallEvents, 2000);
    checkForCallEvents();
}

function checkForCallEvents() {
    fetch('/api/call-events/poll', {
        headers: {
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.has_call && data.event_id !== currentEventId && !isCallActive) {
            currentEventId = data.event_id;
            isCallActive = true;
            showAutomaticCallModal();
        } else if (!data.has_call && isCallActive) {
            isCallActive = false;
        }
    })
    .catch(error => console.error('Polling error:', error));
}

function showAutomaticCallModal() {
    if (!currentLeadId) return;

    const leadRow = document.querySelector(`tr[data-lead-id="${currentLeadId}"]`);
    if (!leadRow) return;

    const customerName = leadRow.dataset.customerName;
    const phone = leadRow.dataset.phone;
    const daysAgo = parseInt(leadRow.dataset.daysAgo);

    // Fill modal
    document.getElementById('modalCustomerName').textContent = customerName;
    document.getElementById('modalPhone').textContent = phone;
    document.getElementById('modalDays').textContent = daysAgo + ' days';
    
    const isRetained = daysAgo < 30;
    const typeHtml = isRetained 
        ? '<span class="badge bg-success">RETAINED (< 30 days)</span>'
        : '<span class="badge bg-warning">REWRITE (≥ 30 days)</span>';
    document.getElementById('modalType').innerHTML = typeHtml;

    // Show modal
    const modalElement = document.getElementById('callDetailsModal');
    if (!callModalInstance) {
        callModalInstance = new bootstrap.Modal(modalElement);
    }
    callModalInstance.show();
}

function dialLead(leadId, phone, customerName, daysAgo, button) {
    if (!phone) {
        toastr.error('No phone number available', 'Error');
        return;
    }

    currentLeadId = leadId;

    // Track call initiation
    fetch('/api/call-logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            lead_id: leadId,
            phone_number: phone,
            status: 'initiated'
        })
    });

    // Clean phone and initiate Zoom call
    const cleanPhone = phone.replace(/[^\d\+]/g, '');
    const zoomUrl = 'zoomphonecall://' + encodeURIComponent(cleanPhone);
    window.location.href = zoomUrl;

    // Update UI
    const row = button.closest('tr');
    row.classList.add('table-success');
    
    toastr.info('Initiating call to ' + customerName + '...', 'Dialing');

    setTimeout(() => row.classList.remove('table-success'), 5000);
}

function submitSaleFromModal() {
    const leadId = currentLeadId;
    const saleDate = document.getElementById('modalSaleDate').value;
    const notes = document.getElementById('modalNotes').value;

    if (!saleDate) {
        toastr.error('Please select a sale date', 'Error');
        return;
    }

    toastr.info('Submitting sale...', 'Processing');

    $.ajax({
        url: `/leads/${leadId}/retention-sale`,
        method: 'POST',
        data: {
            _token: '{{ csrf_token() }}',
            sale_date: saleDate,
            notes: notes
        },
        success: function(response) {
            if (response.success) {
                toastr.success(response.message, 'Success');
                if (callModalInstance) callModalInstance.hide();
                isCallActive = false;
                currentEventId = null;
                setTimeout(() => window.location.reload(), 2000);
            } else {
                toastr.error(response.message || 'Failed to mark sale', 'Error');
            }
        },
        error: function(xhr) {
            toastr.error(xhr.responseJSON?.message || 'An error occurred', 'Error');
        }
    });
}
</script>

<!-- AUTOMATIC CALL POPUP MODAL (Like Ravens) -->
<div class="modal fade" id="callDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20893a 100%);">
                <h5 class="modal-title text-white"><i class="bx bx-phone-call me-2"></i>Call Connected - Mark as Retention Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4">
                    <div class="mb-4">
                        <i class="bx bx-phone-call text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h3 class="mb-3 text-success" id="modalCustomerName">Customer Name</h3>
                    <p class="lead mb-3" id="modalPhone"></p>
                    
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-6">
                                <strong>Days Since Chargeback:</strong><br>
                                <span id="modalDays" class="fs-5"></span>
                            </div>
                            <div class="col-6">
                                <strong>Retention Type:</strong><br>
                                <span id="modalType"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <label class="form-label text-start w-100 fw-bold">Sale Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control form-control-lg" id="modalSaleDate" value="{{ date('Y-m-d') }}">
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label text-start w-100 fw-bold">Notes (Optional)</label>
                            <textarea class="form-control" id="modalNotes" rows="4" placeholder="Enter any notes about this retention call..."></textarea>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-4 mb-0">
                        <i class="bx bx-info-circle me-2"></i> 
                        <strong>What happens next:</strong><br>
                        <small>
                            • A new sale record will be created with you as the closer<br>
                            • Automatically marked as <strong>Retained</strong> (&lt;30 days) or <strong>Rewrite</strong> (≥30 days)<br>
                            • Will go through QA and Manager approval process
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bx bx-x me-1"></i> End Call (No Sale)
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="submitSaleFromModal()">
                    <i class="bx bx-check-circle me-1"></i> Confirm Sale
                </button>
            </div>
        </div>
    </div>
</div>

@endsection
